<<<<<<< HEAD
# ğŸ—ï¸ System Architecture - Passport Reader API

Ğ¦ĞµĞ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ¿Ğ¸ÑÑƒÑ” Ğ°Ñ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¸ Passport Reader API Ğ½Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ñƒ, ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ–Ğ² Ñ‚Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºÑ–Ğ² Ğ´Ğ°Ğ½Ğ¸Ñ….

## ğŸ“ ĞÑ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ° Ğ´Ñ–Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ° Ğ²Ğ¸ÑĞ¾ĞºĞ¾Ğ³Ğ¾ Ñ€Ñ–Ğ²Ğ½Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      End User Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚         Web Browser (HTML/JS/CSS)                       â”‚   â”‚
â”‚  â”‚    - Ğ’ĞµĞ±-Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ· Ğ¿Ğ¾Ğ»ĞµĞ¼ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñƒ              â”‚   â”‚
â”‚  â”‚    - Async Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ API (Fetch API)                    â”‚   â”‚
â”‚  â”‚    - Ğ”Ğ¾Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ (Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ, Ğ½Ğ¾Ğ¼ĞµÑ€)       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ HTTP (GET /)                       â”‚
â”‚                            â”‚ HTTP (POST /api/process)           â”‚
â”‚                            â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer (API)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Server (api.py)                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Endpoints:                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /             â†’ ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” HTML           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - POST /api/process â†’ ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /api/health   â†’ Health check             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /api/info     â†’ Info ÑĞµÑ€Ğ²Ñ–ÑÑƒ             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Middleware:                                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Error Handling                               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Request Validation (Pydantic)                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - CORS (if needed)                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Logging                                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ Method calls                        â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Inference Engine (inference.py)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ PassportOCREngine Class:                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _load_model(self):                         â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ AutoProcessor.from_pretrained()       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ AutoModelForCausalLM.from_pretrained()â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     (torch.float16, SDPA attn.)          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _load_image(self, path):                  â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ PIL.Image.open() â†’ RGB               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ process_image(self, path):                â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ                â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ĞŸÑ€ĞµĞ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸Ğ½Ğ³ (processor)              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ†Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– (generate)            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ”ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ–Ğ²               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ’Ğ¸Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° (regex)              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Base64 ĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ           â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _extract_passport_number(self, text):    â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ID-ĞºĞ°Ñ€Ñ‚ĞºĞ°: 9 Ñ†Ğ¸Ñ„Ñ€ (regex)            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ½Ğ° ĞºĞ½Ğ¸Ğ¶: 2 Ğ»Ñ–Ñ‚ĞµÑ€Ğ¸ + 6 Ñ†Ğ¸Ñ„Ñ€    â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Int'l Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚: 9 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²             â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ Model operations                    â”‚
â”‚                            â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Model Layer (GPU)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Florence-2-Large Model (0.77B Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ²)             â”‚   â”‚
â”‚  â”‚  â”œâ”€ Vision Encoder (ViT-like)                           â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ĞĞ±Ñ€Ğ¾Ğ±Ğ»ÑÑ” Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ [B, 3, H, W]               â”‚   â”‚
â”‚  â”‚  â”‚     â†’ Embedded Tokens [B, Tokens, Embed_dim]        â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Language Model Decoder (LLaMA-like)                â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ĞĞ±Ñ€Ğ¾Ğ±Ğ»ÑÑ” Ñ‚ĞµĞºÑÑ‚ + image embeddings              â”‚   â”‚
â”‚  â”‚  â”‚     â†’ Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” OCR Ñ‚ĞµĞºÑÑ‚                             â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â””â”€ Attention: SDPA (FP16 fÃ¼r memory optimization)     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Device:                                                 â”‚   â”‚
â”‚  â”‚  â””â”€ NVIDIA GPU (CUDA 12.1)                             â”‚   â”‚
â”‚  â”‚     Memory: ~2.5-3.5 GB VRAM                           â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Storage Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./models/florence2-large/                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ config.json                                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ model.safetensors (~18GB)                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ modeling_florence2.py (patched)                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ processing_florence2.py                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ preprocessor_config.json                            â”‚   â”‚
â”‚  â”‚  â””â”€ tokenizer.json                                      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./logs/                                                â”‚   â”‚
â”‚  â”‚  â””â”€ passport_api.log                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./static/                                              â”‚   â”‚
â”‚  â”‚  â””â”€ index.html                                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow

### Flow 1: User Request â†’ Infer â†’ Response

```
1. User Input
   â”œâ”€ Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ” http://127.0.0.1:8000/ Ñƒ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ–
   â””â”€ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑˆĞ»ÑÑ…: "D:\Images\passport.jpg"

2. Frontend (JS)
   â”œâ”€ Ğ’Ğ°Ğ»Ñ–Ğ´ÑƒÑ” ÑˆĞ»ÑÑ… (Ğ½Ğµ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹)
   â”œâ”€ Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ” POST Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ğ´Ğ¾ /api/process Ğ· JSON:
   â”‚  {
   â”‚    "file_path": "D:\\Images\\passport.jpg"
   â”‚  }
   â””â”€ ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ” spinner

3. FastAPI Endpoint (api.py)
   â”œâ”€ @app.post("/api/process")
   â”œâ”€ Ğ’Ğ°Ğ»Ñ–Ğ´ÑƒÑ” request (Pydantic)
   â”œâ”€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ” ocr_engine.process_image()
   â””â”€ ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ” Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

4. Inference Engine (inference.py)
   â”œâ”€ _load_image()
   â”‚  â””â”€ PIL.Image.open("D:\\Images\\passport.jpg") â†’ RGB Image
   â”‚
   â”œâ”€ processor()
   â”‚  â”œâ”€ Ğ¢ĞµĞºÑÑ‚: "<OCR>"
   â”‚  â”œâ”€ Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ: RGB Image
   â”‚  â””â”€ â†’ Tensor inputs ["input_ids", "pixel_values"]
   â”‚
   â”œâ”€ model.generate()
   â”‚  â”œâ”€ Ğ†Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ Ğ½Ğ° GPU (FP16, SDPA)
   â”‚  â”œâ”€ Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” Ñ‚Ğ¾ĞºĞµĞ½Ğ¸ (max_new_tokens=256)
   â”‚  â””â”€ â†’ generated_ids [1, seq_len]
   â”‚
   â”œâ”€ processor.decode()
   â”‚  â”œâ”€ ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ” Ñ‚Ğ¾ĞºĞµĞ½Ğ¸ Ğ½Ğ° Ñ‚ĞµĞºÑÑ‚
   â”‚  â””â”€ â†’ "<OCR>...(Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ OCR)...</OCR>"
   â”‚
   â”œâ”€ _extract_passport_number()
   â”‚  â”œâ”€ Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ” ÑĞ¿ĞµÑ†. Ñ‚Ğ¾ĞºĞµĞ½Ğ¸
   â”‚  â”œâ”€ Ğ—Ğ°ÑÑ‚Ğ¾ÑĞ¾Ğ²ÑƒÑ” regex patterns
   â”‚  â””â”€ â†’ passport_number: "123456789" Ğ°Ğ±Ğ¾ None
   â”‚
   â””â”€ ĞšĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ
      â”œâ”€ PIL Image â†’ JPEG Buffer
      â”œâ”€ Buffer â†’ Base64 string
      â””â”€ â†’ "data:image/jpeg;base64,/9j/4AAQ..."

5. API Response (JSON)
   {
     "status": "success",
     "passport_number": "123456789",
     "image_base64": "data:image/jpeg;base64,/9j/4AAQ...",
     "ocr_text": "(ÑĞ¸Ñ€Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ OCR)",
     "processing_time": "0.45s",
     "error_message": null
   }

6. Frontend (JS)
   â”œâ”€ ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ” JSON Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ
   â”œâ”€ Ğ’Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ” Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ (Base64)
   â”œâ”€ ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ” Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ·ĞµĞ»ĞµĞ½Ğ¸Ğ¹ ÑĞºÑ‰Ğ¾ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)
   â””â”€ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ²ÑƒÑ” spinner
```

---

## ğŸ“¦ Component Architecture

### 1. **FastAPI Application (api.py)**

```python
app = FastAPI(
    title="Passport Reader API",
    version="0.1.0"
)

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
ocr_engine: PassportOCREngine = None

# Events
@app.on_event("startup")     # Cold Start - Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ–
@app.on_event("shutdown")    # Cleanup - Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ· VRAM

# Endpoints
GET  /                        # HTML Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
GET  /api/health             # Ping
GET  /api/info               # Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ
POST /api/process            # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–ÑÑ… OCR
```

**Ğ Ğ¾Ğ»Ñ–:**

- HTTP Ğ·Ğ°Ğ¿Ğ¸Ñ‚/Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ
- Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ Ğ²Ñ…Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ¸Ñ… (Pydantic)
- ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº Ñ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ´Ğ¸
- Ğ›Ğ¾Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ¿Ñ–Ñ‚Ñ–Ğ²

---

### 2. **Inference Engine (inference.py)**

```python
class PassportOCREngine:
    def __init__(self, model_path: str):
        self.model_path = Path(model_path)
        self.device = "cuda" if torch.cuda.is_available() else "cpu"
        self.processor = None
        self.model = None
        self._load_model()
    
    def process_image(self, image_path: str) -> Dict:
        # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ¸
        return {
            "passport_number": "123456789",
            "ocr_text": "...",
            "image": PIL.Image,
            "confidence": 0.85,
            "processing_time": 0.45
        }
```

**Ğ Ğ¾Ğ»Ñ–:**

- ĞšĞµÑ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ»Ñ (Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ, Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ, Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ)
- ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ
- Ğ’Ğ¸Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (regex)

---

### 3. **Configuration (config.py)**

```python
# Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° ĞºĞ¾Ğ½Ñ„Ñ–Ğ³ÑƒÑ€Ğ°Ñ†Ñ–Ñ Ğ²ÑÑ–Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ²

# ĞœĞ¾Ğ´ĞµĞ»ÑŒ
MODEL_NAME = "microsoft/Florence-2-large"
MODEL_CONFIG = {
    "torch_dtype": "float16",
    "attn_implementation": "sdpa",
    ...
}

# API
API_HOST = "127.0.0.1"
API_PORT = 8000

# ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸
PASSPORT_REGEX_PATTERNS = {
    "ukrainian_id_card": r"...",
    "passport_book": r"...",
    ...
}
```

---

### 4. **Frontend (static/index.html)**

```html
<!-- Pure HTML/CSS/JS (Ğ±ĞµĞ· Ñ„Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€ĞºÑ–Ğ²) -->

<!-- Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°: -->
<input type="text" id="filePath">                  <!-- Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ ÑˆĞ»ÑÑ…Ñƒ -->
<button onclick="processImage()">ĞĞ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸</button> <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° -->
<div id="resultsSection">                          <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸ -->
  <img id="imagePreview">                           <!-- Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ -->
  <div id="passportNumber">ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°</div>    <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ -->
</div>

<!-- JavaScript: -->
<script>
    async function processImage() {
        const response = await fetch('/api/process', {
            method: 'POST',
            body: JSON.stringify({ file_path: ... })
        });
        const data = await response.json();
        displayResults(data);
    }
</script>
```

---

## ğŸ” Security Architecture

### 1. Input Validation

```python
# Pydantic Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ—
class ProcessRequest(BaseModel):
    file_path: str  # Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ Ñ‚Ğ¸Ğ¿Ñƒ, Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ğ½Ğ¸

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ñƒ
if not Path(file_path).exists():
    raise FileNotFoundError()
```

### 2. Error Handling

```python
try:
    result = ocr_engine.process_image(file_path)
except FileNotFoundError:
    raise HTTPException(status_code=404)
except torch.cuda.OutOfMemoryError:
    raise HTTPException(status_code=500, detail="GPU OOM")
```

### 3. Resource Management

```python
# Cold Start (Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ)
@app.on_event("startup")
async def startup():
    global ocr_engine
    ocr_engine = PassportOCREngine(...)  # ~3-5 ÑĞµĞº

# Cleanup Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ¼Ğ¸ĞºĞ°Ğ½Ğ½Ñ–
@app.on_event("shutdown")
async def shutdown():
    ocr_engine.cleanup()
    torch.cuda.empty_cache()
```

---

## ğŸ¯ Performance Characteristics

### Latency

| Stage | Time | Notes |
|-------|------|-------|
| Cold Start | 3-5s | Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ½Ğ° GPU |
| Warm Inference | 0.3-0.8s | Ğ¡Ğ°Ğ¼ infer Florence-2 |
| Preprocessing | 0.05s | PIL Image.open + processor |
| Postprocessing | 0.1s | Regex extraction + Base64 |
| **Total** | **~0.5-1.0s** | Per image (warm) |

### Memory

| Component | Memory | Notes |
|-----------|--------|-------|
| Model weights | 2.0-2.5 GB | FP16 quantization |
| Activation memory | 0.5 GB | During inference |
| Cache + OS | 0.5 GB | PyTorch cache, OS |
| **Total Peak** | **~3.5 GB** | VRAM requirements |

### Throughput

- **Single GPU**: ~1 image/sec (sequential)
- **Batch processing**: 4-5 images/sec (with queue)
- **Concurrent requests**: Limited by VRAM (1 at a time for 4GB GPU)

---

## ğŸ› ï¸ Module Dependencies

```
api.py
â”œâ”€â”€ inference.py
â”‚   â”œâ”€â”€ torch (PyTorch - GPU computation)
â”‚   â”œâ”€â”€ transformers (HuggingFace - Model loading)
â”‚   â””â”€â”€ PIL (Image processing)
â”‚
â”œâ”€â”€ config.py
â”‚   â””â”€â”€ pathlib (Path handling)
â”‚
â”œâ”€â”€ models/florence2-large/
â”‚   â”œâ”€â”€ model.safetensors (Model weights)
â”‚   â”œâ”€â”€ modeling_florence2.py
â”‚   â””â”€â”€ processing_florence2.py
â”‚
â””â”€â”€ static/
    â””â”€â”€ index.html
```

---

## ğŸ”„ State Management

### Global State

```python
# api.py - Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ° Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ°
ocr_engine: Optional[PassportOCREngine] = None

# Lifecycle:
# 1. Startup â†’ __init__() â†’ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
# 2. Requests â†’ process_image() â†’ Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ
# 3. Shutdown â†’ cleanup() â†’ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ VRAM
```

### No Session State

```python
# Ğ¡ĞµÑ€Ğ²Ğ¸Ñ STATELESS Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ²
# ĞšĞ¾Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¸Ğ¹
# ĞĞµĞ¼Ğ°Ñ” ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ² Ğ°Ğ±Ğ¾ ÑĞµÑÑ–Ğ¹
```

---

## ğŸš€ Scaling Strategies

### Vertical Scaling (Ğ¾Ğ´Ğ¸Ğ½ GPU)

- Ğ—Ğ±Ñ–Ğ»ÑŒÑˆĞ¸Ñ‚Ğ¸ VRAM (RTX 4090 Ñ–Ğ· 24GB)
- ĞĞ¿Ñ‚Ğ¸Ğ¼Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ (batch processing)

### Horizontal Scaling (ĞºÑ–Ğ»ÑŒĞºĞ° GPUs)

- Multi-GPU inference (torch.nn.DataParallel)
- Load balancer (Nginx/HAProxy)
- Message queue (Redis/RabbitMQ)

### Model Optimization

- Quantization (INT8, INT4)
- Pruning
- Knowledge distillation

---

## ğŸ“Š System Diagram (PlantUML)

```plantuml
@startuml
skinparam backgroundColor #f5f5f5

actor User
participant Browser
participant FastAPI
participant PassportOCR
participant Florence2
database Disk

User -> Browser: 1. Open http://127.0.0.1:8000
Browser -> FastAPI: 2. GET /
FastAPI -> Disk: 3. Read static/index.html
Disk --> FastAPI: HTML content
FastAPI --> Browser: 4. HTML page

User -> Browser: 5. Enter file_path
Browser -> FastAPI: 6. POST /api/process\n(file_path)
FastAPI -> PassportOCR: 7. process_image(path)
PassportOCR -> Disk: 8. Load image
Disk --> PassportOCR: Image bytes
PassportOCR -> Florence2: 9. Generate OCR
Florence2 --> PassportOCR: OCR text
PassportOCR -> PassportOCR: 10. Extract passport\nvia regex
PassportOCR --> FastAPI: Result dict
FastAPI -> Browser: 11. JSON response
Browser -> Browser: 12. Display results\n(image + number)

@enduml
```

---

## ğŸ¯ Design Patterns Used

### 1. **Singleton Pattern**

- `ocr_engine` - Ğ¾Ğ´Ğ¸Ğ½ ĞµĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ°

### 2. **Factory Pattern**

- `PassportOCREngine.__init__()` - ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ” Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ

### 3. **Strategy Pattern**

- Regex patterns Ğ´Ğ»Ñ Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… Ñ‚Ğ¸Ğ¿Ñ–Ğ² Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ñ–Ğ²

### 4. **Dependency Injection**

- ĞšĞ¾Ğ½Ñ„Ñ–Ğ³ Ñ‡ĞµÑ€ĞµĞ· `config.py`
- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ² Ğ´Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¹

---

**Ğ’ĞµÑ€ÑÑ–Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ—:** 1.0  
**ĞÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:** 2026/02/10
=======
# ğŸ—ï¸ System Architecture - Passport Reader API

Ğ¦ĞµĞ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ¿Ğ¸ÑÑƒÑ” Ğ°Ñ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¸ Passport Reader API Ğ½Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ñƒ, ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ–Ğ² Ñ‚Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºÑ–Ğ² Ğ´Ğ°Ğ½Ğ¸Ñ….

## ğŸ“ ĞÑ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ° Ğ´Ñ–Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ° Ğ²Ğ¸ÑĞ¾ĞºĞ¾Ğ³Ğ¾ Ñ€Ñ–Ğ²Ğ½Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      End User Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚         Web Browser (HTML/JS/CSS)                       â”‚   â”‚
â”‚  â”‚    - Ğ’ĞµĞ±-Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ· Ğ¿Ğ¾Ğ»ĞµĞ¼ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñƒ              â”‚   â”‚
â”‚  â”‚    - Async Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ API (Fetch API)                    â”‚   â”‚
â”‚  â”‚    - Ğ”Ğ¾Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ (Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ, Ğ½Ğ¾Ğ¼ĞµÑ€)       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ HTTP (GET /)                       â”‚
â”‚                            â”‚ HTTP (POST /api/process)           â”‚
â”‚                            â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer (API)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Server (api.py)                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Endpoints:                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /             â†’ ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” HTML           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - POST /api/process â†’ ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /api/health   â†’ Health check             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - GET /api/info     â†’ Info ÑĞµÑ€Ğ²Ñ–ÑÑƒ             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Middleware:                                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Error Handling                               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Request Validation (Pydantic)                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - CORS (if needed)                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - Logging                                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ Method calls                        â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Inference Engine (inference.py)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ PassportOCREngine Class:                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _load_model(self):                         â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ AutoProcessor.from_pretrained()       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ AutoModelForCausalLM.from_pretrained()â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     (torch.float16, SDPA attn.)          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _load_image(self, path):                  â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ PIL.Image.open() â†’ RGB               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ process_image(self, path):                â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ                â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ĞŸÑ€ĞµĞ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸Ğ½Ğ³ (processor)              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ†Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– (generate)            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ”ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ–Ğ²               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ğ’Ğ¸Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° (regex)              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Base64 ĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ           â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ _extract_passport_number(self, text):    â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ID-ĞºĞ°Ñ€Ñ‚ĞºĞ°: 9 Ñ†Ğ¸Ñ„Ñ€ (regex)            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ½Ğ° ĞºĞ½Ğ¸Ğ¶: 2 Ğ»Ñ–Ñ‚ĞµÑ€Ğ¸ + 6 Ñ†Ğ¸Ñ„Ñ€    â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Int'l Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚: 9 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²             â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–²                                     â”‚
â”‚                            â”‚ Model operations                    â”‚
â”‚                            â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Model Layer (GPU)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Florence-2-Large Model (0.77B Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ²)             â”‚   â”‚
â”‚  â”‚  â”œâ”€ Vision Encoder (ViT-like)                           â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ĞĞ±Ñ€Ğ¾Ğ±Ğ»ÑÑ” Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ [B, 3, H, W]               â”‚   â”‚
â”‚  â”‚  â”‚     â†’ Embedded Tokens [B, Tokens, Embed_dim]        â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Language Model Decoder (LLaMA-like)                â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ĞĞ±Ñ€Ğ¾Ğ±Ğ»ÑÑ” Ñ‚ĞµĞºÑÑ‚ + image embeddings              â”‚   â”‚
â”‚  â”‚  â”‚     â†’ Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” OCR Ñ‚ĞµĞºÑÑ‚                             â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â””â”€ Attention: SDPA (FP16 fÃ¼r memory optimization)     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Device:                                                 â”‚   â”‚
â”‚  â”‚  â””â”€ NVIDIA GPU (CUDA 12.1)                             â”‚   â”‚
â”‚  â”‚     Memory: ~2.5-3.5 GB VRAM                           â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Storage Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./models/florence2-large/                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ config.json                                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ model.safetensors (~18GB)                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ modeling_florence2.py (patched)                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ processing_florence2.py                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ preprocessor_config.json                            â”‚   â”‚
â”‚  â”‚  â””â”€ tokenizer.json                                      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./logs/                                                â”‚   â”‚
â”‚  â”‚  â””â”€ passport_api.log                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ./static/                                              â”‚   â”‚
â”‚  â”‚  â””â”€ index.html                                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow

### Flow 1: User Request â†’ Infer â†’ Response

```
1. User Input
   â”œâ”€ Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ” http://127.0.0.1:8000/ Ñƒ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ–
   â””â”€ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑˆĞ»ÑÑ…: "D:\Images\passport.jpg"

2. Frontend (JS)
   â”œâ”€ Ğ’Ğ°Ğ»Ñ–Ğ´ÑƒÑ” ÑˆĞ»ÑÑ… (Ğ½Ğµ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹)
   â”œâ”€ Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ” POST Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ğ´Ğ¾ /api/process Ğ· JSON:
   â”‚  {
   â”‚    "file_path": "D:\\Images\\passport.jpg"
   â”‚  }
   â””â”€ ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ” spinner

3. FastAPI Endpoint (api.py)
   â”œâ”€ @app.post("/api/process")
   â”œâ”€ Ğ’Ğ°Ğ»Ñ–Ğ´ÑƒÑ” request (Pydantic)
   â”œâ”€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ” ocr_engine.process_image()
   â””â”€ ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ” Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

4. Inference Engine (inference.py)
   â”œâ”€ _load_image()
   â”‚  â””â”€ PIL.Image.open("D:\\Images\\passport.jpg") â†’ RGB Image
   â”‚
   â”œâ”€ processor()
   â”‚  â”œâ”€ Ğ¢ĞµĞºÑÑ‚: "<OCR>"
   â”‚  â”œâ”€ Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ: RGB Image
   â”‚  â””â”€ â†’ Tensor inputs ["input_ids", "pixel_values"]
   â”‚
   â”œâ”€ model.generate()
   â”‚  â”œâ”€ Ğ†Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ Ğ½Ğ° GPU (FP16, SDPA)
   â”‚  â”œâ”€ Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” Ñ‚Ğ¾ĞºĞµĞ½Ğ¸ (max_new_tokens=256)
   â”‚  â””â”€ â†’ generated_ids [1, seq_len]
   â”‚
   â”œâ”€ processor.decode()
   â”‚  â”œâ”€ ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ” Ñ‚Ğ¾ĞºĞµĞ½Ğ¸ Ğ½Ğ° Ñ‚ĞµĞºÑÑ‚
   â”‚  â””â”€ â†’ "<OCR>...(Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ OCR)...</OCR>"
   â”‚
   â”œâ”€ _extract_passport_number()
   â”‚  â”œâ”€ Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ” ÑĞ¿ĞµÑ†. Ñ‚Ğ¾ĞºĞµĞ½Ğ¸
   â”‚  â”œâ”€ Ğ—Ğ°ÑÑ‚Ğ¾ÑĞ¾Ğ²ÑƒÑ” regex patterns
   â”‚  â””â”€ â†’ passport_number: "123456789" Ğ°Ğ±Ğ¾ None
   â”‚
   â””â”€ ĞšĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ
      â”œâ”€ PIL Image â†’ JPEG Buffer
      â”œâ”€ Buffer â†’ Base64 string
      â””â”€ â†’ "data:image/jpeg;base64,/9j/4AAQ..."

5. API Response (JSON)
   {
     "status": "success",
     "passport_number": "123456789",
     "image_base64": "data:image/jpeg;base64,/9j/4AAQ...",
     "ocr_text": "(ÑĞ¸Ñ€Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ OCR)",
     "processing_time": "0.45s",
     "error_message": null
   }

6. Frontend (JS)
   â”œâ”€ ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ” JSON Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ
   â”œâ”€ Ğ’Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ” Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ (Base64)
   â”œâ”€ ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ” Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ·ĞµĞ»ĞµĞ½Ğ¸Ğ¹ ÑĞºÑ‰Ğ¾ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)
   â””â”€ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ²ÑƒÑ” spinner
```

---

## ğŸ“¦ Component Architecture

### 1. **FastAPI Application (api.py)**

```python
app = FastAPI(
    title="Passport Reader API",
    version="0.1.0"
)

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
ocr_engine: PassportOCREngine = None

# Events
@app.on_event("startup")     # Cold Start - Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ–
@app.on_event("shutdown")    # Cleanup - Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ· VRAM

# Endpoints
GET  /                        # HTML Ñ–Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
GET  /api/health             # Ping
GET  /api/info               # Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ
POST /api/process            # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–ÑÑ… OCR
```

**Ğ Ğ¾Ğ»Ñ–:**

- HTTP Ğ·Ğ°Ğ¿Ğ¸Ñ‚/Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ
- Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ Ğ²Ñ…Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ¸Ñ… (Pydantic)
- ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº Ñ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ´Ğ¸
- Ğ›Ğ¾Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ¿Ñ–Ñ‚Ñ–Ğ²

---

### 2. **Inference Engine (inference.py)**

```python
class PassportOCREngine:
    def __init__(self, model_path: str):
        self.model_path = Path(model_path)
        self.device = "cuda" if torch.cuda.is_available() else "cpu"
        self.processor = None
        self.model = None
        self._load_model()
    
    def process_image(self, image_path: str) -> Dict:
        # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ¸
        return {
            "passport_number": "123456789",
            "ocr_text": "...",
            "image": PIL.Image,
            "confidence": 0.85,
            "processing_time": 0.45
        }
```

**Ğ Ğ¾Ğ»Ñ–:**

- ĞšĞµÑ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ»Ñ (Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ, Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ, Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ)
- ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ
- Ğ’Ğ¸Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (regex)

---

### 3. **Configuration (config.py)**

```python
# Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° ĞºĞ¾Ğ½Ñ„Ñ–Ğ³ÑƒÑ€Ğ°Ñ†Ñ–Ñ Ğ²ÑÑ–Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ²

# ĞœĞ¾Ğ´ĞµĞ»ÑŒ
MODEL_NAME = "microsoft/Florence-2-large"
MODEL_CONFIG = {
    "torch_dtype": "float16",
    "attn_implementation": "sdpa",
    ...
}

# API
API_HOST = "127.0.0.1"
API_PORT = 8000

# ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸
PASSPORT_REGEX_PATTERNS = {
    "ukrainian_id_card": r"...",
    "passport_book": r"...",
    ...
}
```

---

### 4. **Frontend (static/index.html)**

```html
<!-- Pure HTML/CSS/JS (Ğ±ĞµĞ· Ñ„Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€ĞºÑ–Ğ²) -->

<!-- Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°: -->
<input type="text" id="filePath">                  <!-- Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ ÑˆĞ»ÑÑ…Ñƒ -->
<button onclick="processImage()">ĞĞ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸</button> <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° -->
<div id="resultsSection">                          <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸ -->
  <img id="imagePreview">                           <!-- Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ -->
  <div id="passportNumber">ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°</div>    <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ -->
</div>

<!-- JavaScript: -->
<script>
    async function processImage() {
        const response = await fetch('/api/process', {
            method: 'POST',
            body: JSON.stringify({ file_path: ... })
        });
        const data = await response.json();
        displayResults(data);
    }
</script>
```

---

## ğŸ” Security Architecture

### 1. Input Validation

```python
# Pydantic Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ—
class ProcessRequest(BaseModel):
    file_path: str  # Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ Ñ‚Ğ¸Ğ¿Ñƒ, Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ğ½Ğ¸

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ñƒ
if not Path(file_path).exists():
    raise FileNotFoundError()
```

### 2. Error Handling

```python
try:
    result = ocr_engine.process_image(file_path)
except FileNotFoundError:
    raise HTTPException(status_code=404)
except torch.cuda.OutOfMemoryError:
    raise HTTPException(status_code=500, detail="GPU OOM")
```

### 3. Resource Management

```python
# Cold Start (Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ)
@app.on_event("startup")
async def startup():
    global ocr_engine
    ocr_engine = PassportOCREngine(...)  # ~3-5 ÑĞµĞº

# Cleanup Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ¼Ğ¸ĞºĞ°Ğ½Ğ½Ñ–
@app.on_event("shutdown")
async def shutdown():
    ocr_engine.cleanup()
    torch.cuda.empty_cache()
```

---

## ğŸ¯ Performance Characteristics

### Latency

| Stage | Time | Notes |
|-------|------|-------|
| Cold Start | 3-5s | Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ½Ğ° GPU |
| Warm Inference | 0.3-0.8s | Ğ¡Ğ°Ğ¼ infer Florence-2 |
| Preprocessing | 0.05s | PIL Image.open + processor |
| Postprocessing | 0.1s | Regex extraction + Base64 |
| **Total** | **~0.5-1.0s** | Per image (warm) |

### Memory

| Component | Memory | Notes |
|-----------|--------|-------|
| Model weights | 2.0-2.5 GB | FP16 quantization |
| Activation memory | 0.5 GB | During inference |
| Cache + OS | 0.5 GB | PyTorch cache, OS |
| **Total Peak** | **~3.5 GB** | VRAM requirements |

### Throughput

- **Single GPU**: ~1 image/sec (sequential)
- **Batch processing**: 4-5 images/sec (with queue)
- **Concurrent requests**: Limited by VRAM (1 at a time for 4GB GPU)

---

## ğŸ› ï¸ Module Dependencies

```
api.py
â”œâ”€â”€ inference.py
â”‚   â”œâ”€â”€ torch (PyTorch - GPU computation)
â”‚   â”œâ”€â”€ transformers (HuggingFace - Model loading)
â”‚   â””â”€â”€ PIL (Image processing)
â”‚
â”œâ”€â”€ config.py
â”‚   â””â”€â”€ pathlib (Path handling)
â”‚
â”œâ”€â”€ models/florence2-large/
â”‚   â”œâ”€â”€ model.safetensors (Model weights)
â”‚   â”œâ”€â”€ modeling_florence2.py
â”‚   â””â”€â”€ processing_florence2.py
â”‚
â””â”€â”€ static/
    â””â”€â”€ index.html
```

---

## ğŸ”„ State Management

### Global State

```python
# api.py - Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ° Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ°
ocr_engine: Optional[PassportOCREngine] = None

# Lifecycle:
# 1. Startup â†’ __init__() â†’ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
# 2. Requests â†’ process_image() â†’ Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ
# 3. Shutdown â†’ cleanup() â†’ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ VRAM
```

### No Session State

```python
# Ğ¡ĞµÑ€Ğ²Ğ¸Ñ STATELESS Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ²
# ĞšĞ¾Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¸Ğ¹
# ĞĞµĞ¼Ğ°Ñ” ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ² Ğ°Ğ±Ğ¾ ÑĞµÑÑ–Ğ¹
```

---

## ğŸš€ Scaling Strategies

### Vertical Scaling (Ğ¾Ğ´Ğ¸Ğ½ GPU)

- Ğ—Ğ±Ñ–Ğ»ÑŒÑˆĞ¸Ñ‚Ğ¸ VRAM (RTX 4090 Ñ–Ğ· 24GB)
- ĞĞ¿Ñ‚Ğ¸Ğ¼Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ–Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ (batch processing)

### Horizontal Scaling (ĞºÑ–Ğ»ÑŒĞºĞ° GPUs)

- Multi-GPU inference (torch.nn.DataParallel)
- Load balancer (Nginx/HAProxy)
- Message queue (Redis/RabbitMQ)

### Model Optimization

- Quantization (INT8, INT4)
- Pruning
- Knowledge distillation

---

## ğŸ“Š System Diagram (PlantUML)

```plantuml
@startuml
skinparam backgroundColor #f5f5f5

actor User
participant Browser
participant FastAPI
participant PassportOCR
participant Florence2
database Disk

User -> Browser: 1. Open http://127.0.0.1:8000
Browser -> FastAPI: 2. GET /
FastAPI -> Disk: 3. Read static/index.html
Disk --> FastAPI: HTML content
FastAPI --> Browser: 4. HTML page

User -> Browser: 5. Enter file_path
Browser -> FastAPI: 6. POST /api/process\n(file_path)
FastAPI -> PassportOCR: 7. process_image(path)
PassportOCR -> Disk: 8. Load image
Disk --> PassportOCR: Image bytes
PassportOCR -> Florence2: 9. Generate OCR
Florence2 --> PassportOCR: OCR text
PassportOCR -> PassportOCR: 10. Extract passport\nvia regex
PassportOCR --> FastAPI: Result dict
FastAPI -> Browser: 11. JSON response
Browser -> Browser: 12. Display results\n(image + number)

@enduml
```

---

## ğŸ¯ Design Patterns Used

### 1. **Singleton Pattern**

- `ocr_engine` - Ğ¾Ğ´Ğ¸Ğ½ ĞµĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ°

### 2. **Factory Pattern**

- `PassportOCREngine.__init__()` - ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ” Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ

### 3. **Strategy Pattern**

- Regex patterns Ğ´Ğ»Ñ Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… Ñ‚Ğ¸Ğ¿Ñ–Ğ² Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ñ–Ğ²

### 4. **Dependency Injection**

- ĞšĞ¾Ğ½Ñ„Ñ–Ğ³ Ñ‡ĞµÑ€ĞµĞ· `config.py`
- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ² Ğ´Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¹

---

**Ğ’ĞµÑ€ÑÑ–Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ—:** 1.0  
**ĞÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:** 2026/02/10
>>>>>>> 2c20b5e9f2f991ffd3514886a9a19b5f72e8475d
